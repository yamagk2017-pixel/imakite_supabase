name: IHC Weekly Playlist to Spotify

"on":
  workflow_dispatch:
    inputs:
      week_end_date:
        description: "Week end date (YYYY-MM-DD). Default: latest weekly_rankings"
        required: false
        type: string
  workflow_run:
    workflows: ["IHC Weekly Ranking to Supabase"]
    types:
      - completed

jobs:
  run:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: pip install --upgrade supabase requests pynacl
      - name: Run weekly playlist job
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          WEEK_END_DATE: ${{ inputs.week_end_date }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          SPOTIFY_USER_ID: ${{ secrets.SPOTIFY_USER_ID }}
          SPOTIFY_REFRESH_TOKEN_FILE: refresh_token.txt
        run: python scripts/ihc_weekly_playlist_job.py
      - name: Update refresh token secret
        if: ${{ hashFiles('refresh_token.txt') != '' }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python - <<'PY'
          import base64
          import os
          import requests
          from nacl import encoding, public
          
          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GH_PAT"]
          secret_name = "SPOTIFY_REFRESH_TOKEN"
          refresh_path = "refresh_token.txt"
          
          if not token:
              print("GH_PAT is missing. Skipping secret update.")
              raise SystemExit(0)
          
          with open(refresh_path, "r") as f:
              refresh_token = f.read().strip()
          
          if not refresh_token:
              raise SystemExit("No refresh token to update.")
          
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
          }
          key_resp = requests.get(
              f"https://api.github.com/repos/{repo}/actions/secrets/public-key",
              headers=headers,
              timeout=30,
          )
          key_resp.raise_for_status()
          key_data = key_resp.json()
          public_key = public.PublicKey(key_data["key"].encode(), encoding.Base64Encoder())
          sealed_box = public.SealedBox(public_key)
          encrypted = sealed_box.encrypt(refresh_token.encode())
          encrypted_b64 = base64.b64encode(encrypted).decode()
          
          put_resp = requests.put(
              f"https://api.github.com/repos/{repo}/actions/secrets/{secret_name}",
              headers=headers,
              json={"encrypted_value": encrypted_b64, "key_id": key_data["key_id"]},
              timeout=30,
          )
          put_resp.raise_for_status()
          print("Updated GitHub secret:", secret_name)
          PY
